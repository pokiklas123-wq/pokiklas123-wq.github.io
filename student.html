<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Ø·Ø§Ù„Ø¨</title>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { margin: 0; padding: 10px; background: #000; color: white; }
        
        .header {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .live-badge {
            background: #ff0000;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .video-container {
            width: 100%;
            max-width: 1200px;
            margin: auto;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        video {
            width: 100%;
            height: auto;
            max-height: 70vh;
            background: #000;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
        }
        
        .controls {
            text-align: center;
            margin: 15px 0;
        }
        
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
        }
        
        .connection-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .connected { background: rgba(76,175,80,0.2); border: 2px solid #4CAF50; }
        .disconnected { background: rgba(244,67,54,0.2); border: 2px solid #F44336; }
        
        .viewer-info {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="live-badge">â— Ù…Ø¨Ø§Ø´Ø±</div>
        <h2>ğŸ“š Ø§Ù„Ø¨Ø« Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
        <p style="color: #aaa; margin: 5px 0;" id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«...</p>
    </div>
    
    <div class="connection-status disconnected" id="connectionStatus">
        ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...
    </div>
    
    <div class="video-container">
        <div class="loading" id="loading">
            <div style="font-size: 24px; margin-bottom: 10px;">â³</div>
            <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...</p>
            <p style="font-size: 12px; color: #aaa;">Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†ÙŠ</p>
        </div>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>
    
    <div class="controls">
        <button onclick="toggleFullscreen()">ğŸ“º Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
        <button onclick="toggleAudio()" id="audioBtn">ğŸ”Š Ø§Ù„ØµÙˆØª</button>
        <button onclick="reconnect()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„</button>
    </div>
    
    <div class="viewer-info">
        <p>ğŸ‘ï¸ Ø£Ù†Øª Ù…Ø´Ø§Ù‡Ø¯ <span id="viewerNumber">#1</span></p>
        <p>ğŸ• <span id="broadcastTime">00:00</span> Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</p>
    </div>
    
    <div style="text-align: center; margin-top: 20px; color: #888; font-size: 12px;">
        <p>ğŸ”Š ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª | ğŸ“± ÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</p>
        <p>Ù„Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©: Ø§Ø¶ØºØ· "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„" Ø£Ùˆ Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</p>
    </div>

    <script>
        let peerConnection;
        let isConnected = false;
        let startTime;
        let audioMuted = false;
        let ws;
        let studentId;
        let roomId;
        
        // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø·Ø§Ù„Ø¨
        function generateStudentId() {
            return 'student_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        function getRoomId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('room');
        }
        
        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… WebSocket
        function connectWebSocket() {
            roomId = getRoomId();
            
            if (!roomId) {
                showError('âŒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ø·Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³.');
                return;
            }
            
            studentId = generateStudentId();
            
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§Ø¯Ù… WebSocket Ù…Ø¬Ø§Ù†ÙŠ
                ws = new WebSocket('wss://free.blr2.piesocket.com/v3/1?api_key=YOUR_API_KEY&notify_self=1');
                
                ws.onopen = () => {
                    console.log('âœ… Ø§ØªØµÙ„ Ø¨Ø®Ø§Ø¯Ù… WebSocket');
                    
                    // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©
                    ws.send(JSON.stringify({
                        type: 'join',
                        roomId: roomId,
                        studentId: studentId,
                        from: 'student'
                    }));
                    
                    updateStatus('ğŸŸ¡ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«...');
                };
                
                ws.onmessage = async (event) => {
                    const data = JSON.parse(event.data);
                    await handleSignalingMessage(data);
                };
                
                ws.onerror = (error) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ WebSocket:', error);
                    updateStatus('ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
                    setTimeout(connectWebSocket, 3000);
                };
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                useLocalStorageFallback();
            }
        }
        
        // Ø¨Ø¯ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage
        function useLocalStorageFallback() {
            roomId = getRoomId();
            
            if (!roomId) {
                showError('âŒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­.');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø« Ù†Ø´Ø·
            const isActive = localStorage.getItem('broadcast_active_' + roomId);
            const lastTime = localStorage.getItem('broadcast_time_' + roomId);
            
            if (!isActive || !lastTime) {
                updateStatus('â³ Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ø¨Ø«...');
                setTimeout(useLocalStorageFallback, 3000);
                return;
            }
            
            // Ø§Ù„Ø¨Ø« Ù†Ø´Ø·ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC Ù…Ø¨Ø§Ø´Ø±
            createPeerConnection();
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
            setInterval(() => {
                const stillActive = localStorage.getItem('broadcast_active_' + roomId);
                if (!stillActive && isConnected) {
                    showError('âŒ ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø«. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
                    reconnect();
                }
            }, 5000);
        }
        
        async function handleSignalingMessage(data) {
            if (data.type === 'offer' && data.studentId === studentId) {
                // Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³
                await handleOffer(data.offer);
                
            } else if (data.type === 'ice_candidate' && data.studentId === studentId) {
                // Ù…Ø±Ø´Ø­ ICE Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³
                await handleICECandidate(data.candidate);
                
            } else if (data.type === 'broadcast_started') {
                // Ø§Ù„Ø¨Ø« Ø¨Ø¯Ø£
                updateStatus('ğŸŸ¢ Ø§Ù„Ø¨Ø« Ø¨Ø¯Ø£! Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...');
                
            } else if (data.type === 'broadcast_ended') {
                // Ø§Ù„Ø¨Ø« Ø§Ù†ØªÙ‡Ù‰
                showError('â¹ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.');
            }
        }
        
        async function createPeerConnection() {
            try {
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                });
                
                // Ø¹Ù†Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ¯ÙÙ‚
                peerConnection.ontrack = (event) => {
                    console.log('âœ… Ø§Ø³ØªÙ„Ù… ØªØ¯ÙÙ‚ ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØª');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('connectionStatus').className = 'connection-status connected';
                    document.getElementById('connectionStatus').innerHTML = 'ğŸŸ¢ Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø«';
                    document.getElementById('statusText').textContent = 'Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¬Ø§Ø±ÙŠ';
                    isConnected = true;
                    startTime = new Date();
                    updateBroadcastTime();
                };
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'ice_candidate',
                            studentId: studentId,
                            candidate: event.candidate,
                            from: 'student'
                        }));
                    }
                };
                
                peerConnection.oniceconnectionstatechange = () => {
                    console.log('ICE connection state:', peerConnection.iceConnectionState);
                    
                    if (peerConnection.iceConnectionState === 'disconnected' ||
                        peerConnection.iceConnectionState === 'failed') {
                        updateStatus('ğŸ”´ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
                        setTimeout(reconnect, 3000);
                    }
                };
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                showError('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
            }
        }
        
        async function handleOffer(offer) {
            try {
                if (!peerConnection) {
                    await createPeerConnection();
                }
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¬Ø§Ø¨Ø©
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„Ù…Ø¯Ø±Ø³
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'answer',
                        studentId: studentId,
                        answer: answer,
                        from: 'student'
                    }));
                }
                
                updateStatus('ğŸŸ¢ Ù…ØªØµÙ„! Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨Ø«...');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶:', error);
                showError('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
            }
        }
        
        async function handleICECandidate(candidate) {
            try {
                if (peerConnection && candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø´Ø­ ICE:', error);
            }
        }
        
        function toggleFullscreen() {
            const video = document.getElementById('remoteVideo');
            
            if (!document.fullscreenElement) {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                    video.webkitRequestFullscreen();
                } else if (video.mozRequestFullScreen) {
                    video.mozRequestFullScreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                }
            }
        }
        
        function toggleAudio() {
            const video = document.getElementById('remoteVideo');
            const audioBtn = document.getElementById('audioBtn');
            
            if (audioMuted) {
                video.muted = false;
                audioBtn.textContent = 'ğŸ”Š Ø§Ù„ØµÙˆØª';
                audioMuted = false;
            } else {
                video.muted = true;
                audioBtn.textContent = 'ğŸ”‡ ÙƒØªÙ…';
                audioMuted = true;
            }
        }
        
        function reconnect() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            isConnected = false;
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionStatus').innerHTML = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('statusText').textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...';
            
            setTimeout(() => {
                connectWebSocket();
            }, 1000);
        }
        
        function updateBroadcastTime() {
            if (!startTime) return;
            
            setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(diff / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;
                
                let timeStr = '';
                if (hours > 0) {
                    timeStr += hours.toString().padStart(2, '0') + ':';
                }
                timeStr += minutes.toString().padStart(2, '0') + ':' + 
                          seconds.toString().padStart(2, '0');
                
                document.getElementById('broadcastTime').textContent = timeStr;
            }, 1000);
        }
        
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        function showError(message) {
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionStatus').innerHTML = message;
            document.getElementById('statusText').textContent = message;
        }
        
        // ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = () => {
            connectWebSocket();
            
            // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            const viewerNum = Math.floor(Math.random() * 100) + 1;
            document.getElementById('viewerNumber').textContent = '#' + viewerNum;
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(() => {
                if (isConnected && peerConnection) {
                    const state = peerConnection.iceConnectionState;
                    if (state !== 'connected' && state !== 'completed') {
                        reconnect();
                    }
                }
            }, 30000);
        };
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', () => {
            if (peerConnection) {
                peerConnection.close();
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
        });
    </script>
</body>
    </html>
