<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Ø·Ø§Ù„Ø¨</title>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { margin: 0; padding: 10px; background: #000; color: white; }
        
        .header {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .live-badge {
            background: #ff0000;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .video-container {
            width: 100%;
            max-width: 1200px;
            margin: auto;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        
        video {
            width: 100%;
            height: auto;
            max-height: 70vh;
        }
        
        .controls {
            text-align: center;
            margin: 15px 0;
        }
        
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
        }
        
        .connection-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .connected { background: rgba(76,175,80,0.2); border: 2px solid #4CAF50; }
        .disconnected { background: rgba(244,67,54,0.2); border: 2px solid #F44336; }
        
        .viewer-info {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="live-badge">â— Ù…Ø¨Ø§Ø´Ø±</div>
        <h2>ğŸ“š Ø§Ù„Ø¨Ø« Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
        <p style="color: #aaa; margin: 5px 0;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«...</p>
    </div>
    
    <div class="connection-status disconnected" id="connectionStatus">
        ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...
    </div>
    
    <div class="video-container">
        <video id="remoteVideo" autoplay controls playsinline></video>
    </div>
    
    <div class="controls">
        <button onclick="toggleFullscreen()">ğŸ“º Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
        <button onclick="toggleAudio()" id="audioBtn">ğŸ”Š Ø§Ù„ØµÙˆØª</button>
        <button onclick="reconnect()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„</button>
    </div>
    
    <div class="viewer-info">
        <p>ğŸ‘ï¸ <span id="viewerCount">1</span> Ù…Ø´Ø§Ù‡Ø¯</p>
        <p>ğŸ• <span id="broadcastTime">00:00</span> Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</p>
    </div>
    
    <div style="text-align: center; margin-top: 20px; color: #888; font-size: 12px;">
        <p>ğŸ”Š ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª | ğŸ“± ÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</p>
        <p>Ù„Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©: Ø§Ø¶ØºØ· "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„" Ø£Ùˆ Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</p>
    </div>

    <script>
        let peerConnection;
        let isConnected = false;
        let startTime;
        let audioMuted = false;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        function getBroadcastId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«
        async function connectToBroadcast() {
            const broadcastId = getBroadcastId();
            
            if (!broadcastId) {
                document.getElementById('connectionStatus').innerHTML = 
                    'âŒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ø·Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³.';
                return;
            }
            
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† localStorage (Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„Ø®Ø§Ø¯Ù…)
                const offerData = localStorage.getItem('broadcast_offer_' + broadcastId);
                
                if (!offerData) {
                    document.getElementById('connectionStatus').innerHTML = 
                        'â³ Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ø¨Ø«...';
                    setTimeout(connectToBroadcast, 3000);
                    return;
                }
                
                const offer = JSON.parse(offerData);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                });
                
                // Ø¹Ù†Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ¯ÙÙ‚
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    document.getElementById('connectionStatus').className = 'connection-status connected';
                    document.getElementById('connectionStatus').innerHTML = 'ğŸŸ¢ Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø«';
                    isConnected = true;
                    startTime = new Date();
                    updateBroadcastTime();
                };
                
                peerConnection.onicecandidate = (event) => {
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© ICE candidates
                };
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„Ø®Ø§Ø¯Ù…)
                localStorage.setItem('broadcast_answer_' + broadcastId, JSON.stringify(answer));
                
                // Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø¹ÙŠØ¯
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                
                console.log('âœ… Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                document.getElementById('connectionStatus').innerHTML = 
                    'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message;
                setTimeout(connectToBroadcast, 5000);
            }
        }
        
        function toggleFullscreen() {
            const video = document.getElementById('remoteVideo');
            
            if (!document.fullscreenElement) {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                    video.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        }
        
        function toggleAudio() {
            const video = document.getElementById('remoteVideo');
            const audioBtn = document.getElementById('audioBtn');
            
            if (audioMuted) {
                video.muted = false;
                audioBtn.textContent = 'ğŸ”Š Ø§Ù„ØµÙˆØª';
                audioMuted = false;
            } else {
                video.muted = true;
                audioBtn.textContent = 'ğŸ”‡ ÙƒØªÙ…';
                audioMuted = true;
            }
        }
        
        function reconnect() {
            if (peerConnection) {
                peerConnection.close();
            }
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionStatus').innerHTML = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...';
            connectToBroadcast();
        }
        
        function updateBroadcastTime() {
            if (!startTime) return;
            
            setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(diff / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;
                
                let timeStr = '';
                if (hours > 0) {
                    timeStr += hours.toString().padStart(2, '0') + ':';
                }
                timeStr += minutes.toString().padStart(2, '0') + ':' + 
                          seconds.toString().padStart(2, '0');
                
                document.getElementById('broadcastTime').textContent = timeStr;
            }, 1000);
        }
        
        // ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = () => {
            connectToBroadcast();
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
            setInterval(() => {
                const video = document.getElementById('remoteVideo');
                if (isConnected && video.srcObject && 
                    video.srcObject.getTracks().length > 0) {
                    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¬ÙŠØ¯
                } else if (isConnected) {
                    reconnect();
                }
            }, 10000);
        };
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', () => {
            if (peerConnection) {
                peerConnection.close();
            }
        });
    </script>
</body>
</html>
