<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุจุซ ุงููุจุงุดุฑ - ุงููุฏุฑุณ</title>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { margin: 0; padding: 20px; background: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; }
        h1 { color: #1a73e8; text-align: center; }
        .video-container {
            width: 100%; max-width: 800px; margin: 20px auto;
            background: black; border-radius: 10px; overflow: hidden;
        }
        video { width: 100%; height: auto; max-height: 500px; }
        .controls { text-align: center; margin: 20px 0; }
        button {
            background: #1a73e8; color: white; border: none;
            padding: 15px 30px; border-radius: 5px; margin: 10px;
            font-size: 18px; cursor: pointer;
        }
        button:disabled { background: #ccc; }
        .url-box {
            background: #e8f0fe; padding: 15px; border-radius: 5px;
            margin: 20px 0; display: none;
        }
        .status {
            padding: 10px; border-radius: 5px; margin: 10px 0;
            text-align: center;
        }
        .active { background: #d4edda; color: #155724; }
        .inactive { background: #f8d7da; color: #721c24; }
        .viewers {
            background: #fff3cd; padding: 10px; border-radius: 5px;
            margin: 10px 0; text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>๐ ุจุซ ูุจุงุดุฑ ูู ุตูุญุชู - ุงููุฏุฑุณ</h1>
        
        <div class="video-container">
            <video id="localVideo" autoplay muted></video>
        </div>
        
        <div class="viewers" id="viewersCount">๐ฅ ุนุฏุฏ ุงููุดุงูุฏูู: <span id="count">0</span></div>
        
        <div class="controls">
            <button onclick="startBroadcast()" id="startBtn">โถ ุจุฏุก ุงูุจุซ</button>
            <button onclick="stopBroadcast()" id="stopBtn" disabled>โน ุฅููุงู ุงูุจุซ</button>
            <button onclick="toggleScreenShare()" id="screenBtn">๐ฅ๏ธ ูุดุงุฑูุฉ ุงูุดุงุดุฉ</button>
        </div>
        
        <div class="status inactive" id="status">โซ ุงูุจุซ ุบูุฑ ูุดุท</div>
        
        <div class="url-box" id="urlBox">
            <h3>๐ ุฑุงุจุท ุงููุดุงูุฏุฉ ููุทูุงุจ:</h3>
            <p id="broadcastUrl">ุฌุงุฑู ุฅูุดุงุก ุงูุฑุงุจุท...</p>
            <button onclick="copyUrl()">๐ ูุณุฎ ุงูุฑุงุจุท</button>
            <p style="color: #666; margin-top: 10px;">
                ุฃุฑุณู ูุฐุง ุงูุฑุงุจุท ููุทูุงุจ ููุดุงูุฏุฉ ุงูุจุซ ุงููุจุงุดุฑ
            </p>
        </div>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-top: 30px;">
            <h3>๐ฏ ููู ูุนูู:</h3>
            <p>1. ุงุถุบุท "ุจุฏุก ุงูุจุซ" โ ุณูุฃุฎุฐ ุฅุฐู ุงููุงููุฑุง ูุงููููุฑูููู</p>
            <p>2. ุงูุณุฎ ุงูุฑุงุจุท ุงูุฐู ุณูุธูุฑ โ ุฃุฑุณูู ููุทูุงุจ</p>
            <p>3. ุชุญุฏุซ ุจุดูู ุทุจูุนู โ ุงูุทูุงุจ ุณูุดุงูุฏูู ููุณูุนูู</p>
            <p style="color: #d32f2f; font-weight: bold;">
                โ๏ธ ูุฌุจ ูุชุญ ุตูุญุฉ ุงููุฏุฑุณ ุฃููุงู ูุจู ุฅุฑุณุงู ุงูุฑุงุจุท ููุทูุงุจ
            </p>
        </div>
    </div>

    <script>
        let localStream;
        let peerConnections = new Map(); // ุฎุฑูุทุฉ ูุงุชุตุงูุงุช ุงูุทูุงุจ
        let isBroadcasting = false;
        let broadcastUrl = '';
        let isScreenSharing = false;
        let broadcastId;
        let ws;
        
        // WebSocket ููุชูุงุตู ูุน ุงูุทูุงุจ
        const wsUrl = 'wss://free.blr2.piesocket.com/v3/1?api_key=YOUR_API_KEY&notify_self=1';
        // ุฃู ุงุณุชุฎุฏู ุฎุงุฏู ูุญูู: 'ws://localhost:8080'
        
        // ุฅูุดุงุก ูุนุฑู ูุฑูุฏ ููุจุซ
        function generateBroadcastId() {
            return 'class_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ุงูุงุชุตุงู ุจุฎุงุฏู WebSocket
        function connectWebSocket() {
            try {
                // ุงุณุชุฎุฏุงู ุฎุงุฏู WebSocket ูุฌุงูู
                ws = new WebSocket('wss://free.blr2.piesocket.com/v3/1?api_key=YOUR_API_KEY&notify_self=1');
                
                ws.onopen = () => {
                    console.log('โ ุงุชุตู ุจุฎุงุฏู WebSocket');
                    broadcastId = generateBroadcastId();
                    
                    // ุฅูุดุงุก ุฑุงุจุท ุงูุจุซ
                    const currentUrl = window.location.origin + window.location.pathname;
                    const studentUrl = currentUrl.replace('teacher.html', '') + 
                                      'student.html?room=' + broadcastId;
                    
                    broadcastUrl = studentUrl;
                    
                    // ุนุฑุถ ุฑุงุจุท ุงูุทูุงุจ
                    document.getElementById('broadcastUrl').textContent = studentUrl;
                    document.getElementById('urlBox').style.display = 'block';
                    
                    // ุฅุฑุณุงู ุฑุณุงูุฉ ุฅูุดุงุก ุบุฑูุฉ
                    ws.send(JSON.stringify({
                        type: 'create_room',
                        roomId: broadcastId,
                        from: 'teacher'
                    }));
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleSignalingMessage(data);
                };
                
                ws.onerror = (error) => {
                    console.error('โ ุฎุทุฃ ูู WebSocket:', error);
                    // ุงุณุชุฎุฏู localStorage ูุจุฏูู
                    useLocalStorageFallback();
                };
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุงูุงุชุตุงู:', error);
                useLocalStorageFallback();
            }
        }
        
        // ุจุฏูู ุจุงุณุชุฎุฏุงู localStorage
        function useLocalStorageFallback() {
            console.log('โก ุงุณุชุฎุฏุงู localStorage ูุจุฏูู');
            broadcastId = generateBroadcastId();
            
            // ุฅูุดุงุก ุฑุงุจุท ุงูุจุซ
            const currentUrl = window.location.origin + window.location.pathname;
            const studentUrl = currentUrl.replace('teacher.html', '') + 
                              'student.html?room=' + broadcastId;
            
            broadcastUrl = studentUrl;
            document.getElementById('broadcastUrl').textContent = studentUrl;
            document.getElementById('urlBox').style.display = 'block';
            
            // ุชุญุฏูุซ ุงูุนุฑุถ ุงููุญููุธ ูู 2 ุซุงููุฉ
            setInterval(() => {
                if (isBroadcasting) {
                    localStorage.setItem('broadcast_active_' + broadcastId, 'true');
                    localStorage.setItem('broadcast_time_' + broadcastId, Date.now().toString());
                }
            }, 2000);
        }
        
        async function startBroadcast() {
            try {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                // ุทูุจ ุฅุฐู ุงููุงููุฑุง ูุงููููุฑูููู
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: true
                });
                
                // ุนุฑุถ ุงูููุฏูู ุงููุญูู
                document.getElementById('localVideo').srcObject = localStream;
                
                // ุงูุงุชุตุงู ุจุฎุงุฏู ุงูุฅุดุงุฑุฉ
                connectWebSocket();
                
                // ุชุญุฏูุซ ุงูุญุงูุฉ
                isBroadcasting = true;
                document.getElementById('status').className = 'status active';
                document.getElementById('status').textContent = '๐ข ุงูุจุซ ูุดุท - ุฌุงุฑู ุงูุฅุฑุณุงู';
                
                console.log('โ ุงูุจุซ ุจุฏุฃ! ุงูุฑุงุจุท:', broadcastUrl);
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุจุฏุก ุงูุจุซ:', error);
                alert('โ ุฎุทุฃ: ' + error.message + '\n\nุชุฃูุฏ ูู:'
                    + '\n1. ููุญ ุฅุฐู ุงููุงููุฑุง ูุงููููุฑูููู'
                    + '\n2. ุงุณุชุฎุฏุงู HTTPS'
                    + '\n3. ุงุชุตุงู ุฅูุชุฑูุช ุฌูุฏ');
                stopBroadcast();
            }
        }
        
        function handleSignalingMessage(data) {
            if (data.type === 'join') {
                // ุทุงูุจ ุฌุฏูุฏ ุงูุถู
                handleNewStudent(data.studentId);
                updateViewerCount();
                
            } else if (data.type === 'offer') {
                // ุนุฑุถ ูู ุทุงูุจ
                handleStudentOffer(data.studentId, data.offer);
                
            } else if (data.type === 'answer') {
                // ุฅุฌุงุจุฉ ูู ุทุงูุจ
                handleStudentAnswer(data.studentId, data.answer);
                
            } else if (data.type === 'ice_candidate') {
                // ูุฑุดุญ ICE
                handleICECandidate(data.studentId, data.candidate);
            }
        }
        
        async function handleNewStudent(studentId) {
            // ุฅูุดุงุก ุงุชุตุงู WebRTC ุฌุฏูุฏ ููุฐุง ุงูุทุงูุจ
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            });
            
            // ุฅุถุงูุฉ ุงูุชุฏูู ุงููุญูู
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });
            
            // ุฌูุน ูุฑุดุญู ICE
            pc.onicecandidate = (event) => {
                if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'ice_candidate',
                        studentId: studentId,
                        candidate: event.candidate,
                        from: 'teacher'
                    }));
                }
            };
            
            // ุญูุธ ุงูุงุชุตุงู
            peerConnections.set(studentId, pc);
            
            // ุฅูุดุงุก ุนุฑุถ ูุฅุฑุณุงูู ููุทุงูุจ
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'offer',
                    studentId: studentId,
                    offer: offer,
                    from: 'teacher'
                }));
            }
        }
        
        function handleStudentOffer(studentId, offer) {
            // ูุฐู ุงููุธููุฉ ููุงุชุตุงู P2P ุจูู ุงูุทูุงุจ
            // ูู ูุธุงู ุงูุจุซุ ุงููุฏุฑุณ ููุท ูุฑุณู
        }
        
        async function handleStudentAnswer(studentId, answer) {
            const pc = peerConnections.get(studentId);
            if (pc) {
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
            }
        }
        
        function handleICECandidate(studentId, candidate) {
            const pc = peerConnections.get(studentId);
            if (pc) {
                pc.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }
        
        function updateViewerCount() {
            document.getElementById('count').textContent = peerConnections.size;
        }
        
        async function toggleScreenShare() {
            try {
                if (isScreenSharing) {
                    // ุงูุนูุฏุฉ ูููุงููุฑุง
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    
                    // ุงุณุชุจุฏุงู ุงูุชุฏูู ูู ุฌููุน ุงูุงุชุตุงูุงุช
                    replaceStream(stream);
                    localStream = stream;
                    
                    document.getElementById('localVideo').srcObject = localStream;
                    isScreenSharing = false;
                    document.getElementById('screenBtn').textContent = '๐ฅ๏ธ ูุดุงุฑูุฉ ุงูุดุงุดุฉ';
                    
                } else {
                    // ูุดุงุฑูุฉ ุงูุดุงุดุฉ
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });
                    
                    // ุงุณุชุจุฏุงู ุงูุชุฏูู ูู ุฌููุน ุงูุงุชุตุงูุงุช
                    replaceStream(stream);
                    localStream = stream;
                    
                    document.getElementById('localVideo').srcObject = localStream;
                    isScreenSharing = true;
                    document.getElementById('screenBtn').textContent = '๐ท ุงูุนูุฏุฉ ูููุงููุฑุง';
                }
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ูุดุงุฑูุฉ ุงูุดุงุดุฉ:', error);
            }
        }
        
        function replaceStream(newStream) {
            // ุงุณุชุจุฏุงู ุงูุชุฏูู ูู ุฌููุน ุงุชุตุงูุงุช ุงูุทูุงุจ
            peerConnections.forEach((pc, studentId) => {
                const sender = pc.getSenders().find(s => 
                    s.track && s.track.kind === 'video'
                );
                if (sender) {
                    sender.replaceTrack(newStream.getVideoTracks()[0]);
                }
            });
        }
        
        function stopBroadcast() {
            // ุฅุบูุงู ุฌููุน ุงูุงุชุตุงูุงุช
            peerConnections.forEach((pc, studentId) => {
                pc.close();
            });
            peerConnections.clear();
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            isBroadcasting = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').className = 'status inactive';
            document.getElementById('status').textContent = 'โซ ุงูุจุซ ูุชููู';
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('count').textContent = '0';
            
            console.log('โน๏ธ ุงูุจุซ ุชููู');
        }
        
        function copyUrl() {
            navigator.clipboard.writeText(broadcastUrl).then(() => {
                alert('โ ุชู ูุณุฎ ุฑุงุจุท ุงูุจุซ! ุฃุฑุณูู ููุทูุงุจ.');
            });
        }
        
        // ุฅุบูุงู ุงูุจุซ ุนูุฏ ูุบุงุฏุฑุฉ ุงูุตูุญุฉ
        window.addEventListener('beforeunload', () => {
            if (isBroadcasting) {
                stopBroadcast();
            }
        });
    </script>
</body>
</html>
