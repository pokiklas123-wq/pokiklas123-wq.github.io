<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Reader - Ù…Ù†ØµØ© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø§Ù†Ø¬Ø§</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="icon-btn" id="search-toggle" title="Ø¨Ø­Ø«">
                <i class="fas fa-search"></i>
            </button>
            <button class="icon-btn" id="login-toggle" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„">
                <i class="fas fa-sign-in-alt"></i>
            </button>
        </div>

        <div class="header-center">
            <span>ğŸ“– Manga Reader</span>
        </div>

        <div class="header-right">
            <button class="icon-btn" id="theme-toggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±">
                <i class="fas fa-moon"></i>
            </button>
            <button class="icon-btn" id="drawer-toggle" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Search Container -->
    <div class="search-container" id="search-container">
        <input 
            type="text" 
            class="search-input" 
            id="search-input" 
            placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø§Ù†Ø¬Ø§..."
        >
        <button class="icon-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Filter Container -->
    <div class="filter-container">
        <button class="filter-btn active" onclick="filterManga('latest')">Ø§Ù„Ø£Ø­Ø¯Ø«</button>
        <button class="filter-btn" onclick="filterManga('oldest')">Ø§Ù„Ø£Ù‚Ø¯Ù…</button>
        <button class="filter-btn" onclick="filterManga('views')">Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©</button>
        <button class="filter-btn" onclick="filterManga('rating')">Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹</button>
    </div>

    <!-- Manga Grid -->
    <div class="manga-grid" id="manga-grid">
        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-secondary);">
            <div class="spinner"></div>
            <p style="margin-top: 1rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§...</p>
        </div>
    </div>

    <!-- Drawer -->
    <div class="drawer" id="drawer">
        <div class="drawer-header">
            <div class="avatar" id="user-avatar">U</div>
            <div class="drawer-user-info">
                <div class="drawer-username" id="drawer-username">Guest</div>
                <div class="drawer-email" id="drawer-email">guest@example.com</div>
            </div>
        </div>

        <div class="drawer-menu">
            <div class="drawer-menu-item" onclick="navigateTo('profile.html')">
                <i class="fas fa-user"></i> Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ
            </div>
        </div>

        <div class="drawer-section">
            <div class="drawer-section-title">Ø§Ù„Ù…Ø¸Ù‡Ø±</div>
            <div class="theme-options">
                <button class="theme-option active" id="dark-theme-option">
                    <i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø³ÙˆØ¯
                </button>
                <button class="theme-option" id="blue-theme-option">
                    <i class="fas fa-water"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¯Ø§ÙƒÙ†
                </button>
            </div>
        </div>

        <div class="drawer-section">
            <div class="drawer-section-title">Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø§ØªØµØ§Ù„</div>
            <div class="drawer-menu">
                <div class="drawer-menu-item">
                    <i class="fas fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                </div>
                <div class="drawer-menu-item">
                    <i class="fas fa-phone"></i> Ø§Ù„Ø§ØªØµØ§Ù„
                </div>
                <div class="drawer-menu-item">
                    <i class="fas fa-question-circle"></i> Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Scripts - IMPORTANT: Correct Order -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js"></script>
    
    <!-- Load Firebase Config FIRST -->
    <script src="js/firebase-config.js"></script>
    
    <!-- Then load main.js -->
    <script src="js/main.js"></script>
    
    <!-- Finally load page-specific scripts -->
   <script>
    let allMangaData = [];

    // Test if FirebaseDatabase is available
    function testFirebaseDatabase() {
        console.log('ğŸ§ª Testing FirebaseDatabase...');
        
        if (typeof FirebaseDatabase === 'undefined') {
            console.error('âŒ FirebaseDatabase is not defined!');
            showEmptyState('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', 'âŒ', 'FirebaseDatabase ØºÙŠØ± Ù…ØªØ§Ø­. ØªØ­Ù‚Ù‚ Ù…Ù† Console Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.');
            return false;
        }
        
        console.log('âœ… FirebaseDatabase is available!');
        return true;
    }

    // Load manga data from Firebase - UPDATED FOR REAL STRUCTURE
    async function loadMangaCards() {
        const grid = document.getElementById('manga-grid');
        
        // Test Firebase first
        if (!testFirebaseDatabase()) {
            return;
        }

        grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-secondary);">
                <div class="spinner"></div>
                <p style="margin-top: 1rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§...</p>
            </div>
        `;

        try {
            console.log('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ Ù…Ù† Firebase...');
            const mangaList = await FirebaseDatabase.getMangaList();
            
            if (mangaList && mangaList.length > 0) {
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${mangaList.length} Ù…Ø§Ù†Ø¬Ø§`);
                allMangaData = mangaList;
                displayMangaCards(mangaList);
            } else {
                console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø§Ù†Ø¬Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                showEmptyState('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø§Ù†Ø¬Ø§ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'ğŸ“š', 'Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© Ø£Ùˆ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®ØªÙ„Ù.');
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§:', error);
            showEmptyState('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'âŒ', `Ø®Ø·Ø£: ${error.message}`);
        }
    }

    function displayMangaCards(mangaList) {
        const grid = document.getElementById('manga-grid');
        grid.innerHTML = '';

        if (!mangaList || mangaList.length === 0) {
            showEmptyState('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø§Ù†Ø¬Ø§', 'ğŸ“š', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø§Ù†Ø¬Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
            return;
        }

        mangaList.forEach(manga => {
            const card = document.createElement('div');
            card.className = 'manga-card';
            card.onclick = () => navigateTo(`manga_information.html?id=${manga.id}`);
            
            // Calculate chapters count from real data structure
            const chaptersCount = manga.chapters ? Object.keys(manga.chapters).length : 0;
            
            card.innerHTML = `
                <div class="manga-card-image">
                    ${manga.thumbnail && manga.thumbnail.startsWith('http') ? 
                        `<img src="${manga.thumbnail}" alt="${manga.name}" 
                              onerror="this.onerror=null; this.style.display='none'; this.parentNode.innerHTML='ğŸ“š';"
                              loading="lazy">` : 
                        'ğŸ“š'
                    }
                </div>
                <div class="manga-card-content">
                    <div>
                        <div class="manga-title">${manga.name || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</div>
                        <div class="manga-chapter">${chaptersCount} ÙØµÙˆÙ„</div>
                    </div>
                    <div class="manga-stats">
                        <div class="stat-item">
                            <i class="fas fa-star"></i> ${manga.rating || '0.0'}
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-eye"></i> ${formatNumber(manga.views || 0)}
                        </div>
                    </div>
                </div>
            `;
            
            grid.appendChild(card);
        });
    }

    function showEmptyState(title, icon, message) {
        const grid = document.getElementById('manga-grid');
        grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-secondary);">
                <div style="font-size: 4rem; margin-bottom: 1rem;">${icon}</div>
                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">${title}</h3>
                <p>${message}</p>
                <button onclick="checkDataStructure()" class="btn btn-primary" style="margin-top: 1rem;">ÙØ­Øµ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button onclick="loadMangaCards()" class="btn btn-secondary" style="margin-top: 0.5rem;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
            </div>
        `;
    }

    async function checkDataStructure() {
        try {
            const structure = await FirebaseDebug.checkDataStructure();
            alert(`ğŸ“Š Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n\n- Ø§Ù„Ù…Ø§Ù†Ø¬Ø§: ${structure.manga}\n- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${structure.users}\n- Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª: ${structure.comments}`);
        } catch (error) {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        }
    }

    // Filter manga based on real data
    function filterManga(type) {
        if (!allMangaData || allMangaData.length === 0) {
            showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙÙ„ØªØ±Ø©', 'error');
            return;
        }

        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        let sorted = [...allMangaData];

        switch(type) {
            case 'latest':
                sorted.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                break;
            case 'oldest':
                sorted.sort((a, b) => (a.updatedAt || 0) - (b.updatedAt || 0));
                break;
            case 'views':
                sorted.sort((a, b) => (b.views || 0) - (a.views || 0));
                break;
            case 'rating':
                sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                break;
        }

        displayMangaCards(sorted);
    }

    // Search functionality - real data search
    document.getElementById('search-input').addEventListener('keyup', (e) => {
        const query = e.target.value.toLowerCase();
        
        if (!query) {
            displayMangaCards(allMangaData);
            return;
        }

        const filtered = allMangaData.filter(manga => 
            (manga.name || '').toLowerCase().includes(query) ||
            (manga.description || '').toLowerCase().includes(query)
        );

        if (filtered.length === 0) {
            showEmptyState('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬', 'ğŸ”', `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†: "${query}"`);
        } else {
            displayMangaCards(filtered);
        }
    });

    // Update user info in drawer - UPDATED FOR REAL STRUCTURE
    function updateDrawerUserInfo() {
        const user = FirebaseAuth.getCurrentUser();
        if (user) {
            FirebaseDatabase.getUserData(user.uid).then(userData => {
                if (userData) {
                    const displayName = userData.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    const email = userData.email || user.email;
                    
                    document.getElementById('drawer-username').textContent = displayName;
                    document.getElementById('drawer-email').textContent = email;
                    document.getElementById('user-avatar').textContent = displayName.charAt(0).toUpperCase();
                }
            }).catch(error => {
                console.error('Error loading user data:', error);
            });
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
        
        // Load data after a short delay to ensure Firebase is initialized
        setTimeout(() => {
            testFirebaseDatabase();
            loadMangaCards();
            updateDrawerUserInfo();
        }, 1000);

        // Check login status
        FirebaseAuth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-toggle').innerHTML = '<i class="fas fa-sign-out-alt"></i>';
                document.getElementById('login-toggle').onclick = () => {
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                        FirebaseAuth.logout().then(() => {
                            window.location.href = 'index.html';
                        });
                    }
                };
                document.getElementById('login-toggle').title = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬';
                updateDrawerUserInfo();
            } else {
                document.getElementById('login-toggle').innerHTML = '<i class="fas fa-sign-in-alt"></i>';
                document.getElementById('login-toggle').onclick = () => {
                    navigateTo('auth.html');
                };
                document.getElementById('login-toggle').title = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                document.getElementById('drawer-username').textContent = 'Guest';
                document.getElementById('drawer-email').textContent = 'guest@example.com';
                document.getElementById('user-avatar').textContent = 'G';
            }
        });
    });
</script>
</body>
</html>