<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø¬Ø§</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .manga-info-header {
            background: linear-gradient(135deg, var(--secondary-dark) 0%, var(--tertiary-dark) 100%);
            border-bottom: 1px solid var(--border-dark);
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .manga-info-header-icons {
            display: flex;
            gap: 1rem;
        }

        .manga-info-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .manga-hero {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 3rem;
            margin-bottom: 3rem;
        }

        .manga-cover {
            width: 100%;
            aspect-ratio: 3/4;
            background: linear-gradient(135deg, var(--secondary-dark) 0%, var(--tertiary-dark) 100%);
            border-radius: 12px;
            border: 1px solid var(--border-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .manga-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .manga-details {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .manga-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .manga-description {
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .manga-rating-card {
            background-color: var(--secondary-dark);
            border: 1px solid var(--border-dark);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .rating-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .rating-item:last-child {
            margin-bottom: 0;
        }

        .rating-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .rating-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .chapters-section {
            margin-top: 3rem;
        }

        .chapters-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chapters-sort {
            display: flex;
            gap: 0.5rem;
        }

        .sort-btn {
            padding: 0.5rem 1rem;
            background-color: var(--tertiary-dark);
            border: 1px solid var(--border-dark);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .sort-btn:hover,
        .sort-btn.active {
            background-color: var(--accent-color);
            color: var(--primary-dark);
            border-color: var(--accent-color);
        }

        .chapters-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chapter-item {
            background-color: var(--secondary-dark);
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chapter-item:hover {
            background-color: var(--tertiary-dark);
            border-color: var(--accent-color);
            transform: translateX(-5px);
        }

        .chapter-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .chapter-icon {
            font-size: 1.5rem;
            color: var(--accent-color);
        }

        .chapter-details {
            display: flex;
            flex-direction: column;
        }

        .chapter-number {
            font-weight: 600;
            color: var(--text-primary);
        }

        .chapter-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .chapter-read-btn {
            padding: 0.5rem 1rem;
            background-color: var(--accent-color);
            color: var(--primary-dark);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .chapter-read-btn:hover {
            background-color: #00b8d4;
            transform: translateY(-2px);
        }

        .favorite-btn {
            padding: 0.75rem 1.5rem;
            background-color: var(--accent-secondary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .favorite-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.3);
        }

        .favorite-btn.active {
            background-color: #ff4081;
        }

        @media (max-width: 768px) {
            .manga-hero {
                grid-template-columns: 1fr;
            }

            .manga-title {
                font-size: 1.8rem;
            }

            .chapters-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="manga-info-header">
        <button class="icon-btn" onclick="navigateTo('index.html')" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
            <i class="fas fa-home"></i>
        </button>
        <span style="flex: 1; text-align: center; font-weight: 600;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø¬Ø§</span>
        <div class="manga-info-header-icons">
            <button class="icon-btn" id="theme-toggle-manga" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±">
                <i class="fas fa-moon"></i>
            </button>
            <button class="icon-btn favorite-toggle" id="favorite-toggle" title="Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©">
                <i class="far fa-heart"></i>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="manga-info-container">
        <div class="manga-hero">
            <div class="manga-cover" id="manga-cover">ğŸ“š</div>
            <div class="manga-details">
                <div>
                    <h1 class="manga-title" id="manga-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
                    <p class="manga-description" id="manga-description">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                </div>
                
                <div class="manga-rating-card">
                    <div class="rating-item">
                        <span class="rating-label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒÙ„ÙŠ</span>
                        <span class="rating-value" id="manga-rating">0</span>
                    </div>
                    <div class="rating-item">
                        <span class="rating-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</span>
                        <span class="rating-value" id="manga-views">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chapters Section -->
        <div class="chapters-section">
            <div class="chapters-header">
                <span>Ø§Ù„ÙØµÙˆÙ„</span>
                <div class="chapters-sort">
                    <button class="sort-btn active" onclick="sortChapters('latest')">Ø§Ù„Ø£Ø­Ø¯Ø«</button>
                    <button class="sort-btn" onclick="sortChapters('oldest')">Ø§Ù„Ø£Ù‚Ø¯Ù…</button>
                </div>
            </div>
            <div class="chapters-list" id="chapters-list">
                <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/main.js"></script>
  <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù€ HTML ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ -->

<script>
    let currentMangaId = null;
    let currentMangaData = null;
    let allChapters = [];

    // Get manga ID from URL
    function getMangaId() {
        return getQueryParam('id');
    }

    // Load manga details - REAL DATA STRUCTURE
    function loadMangaDetails() {
        currentMangaId = getMangaId();
        if (!currentMangaId) {
            navigateTo('index.html');
            return;
        }

        FirebaseDatabase.getMangaById(currentMangaId).then(manga => {
            if (manga) {
                currentMangaData = manga;
                displayMangaDetails(manga);
                loadChapters();
                checkIfFavorite();
            } else {
                showError('Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            }
        }).catch(error => {
            console.error('Error loading manga:', error);
            showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§: ' + error.message);
        });
    }

    // Display manga details - REAL DATA STRUCTURE
    function displayMangaDetails(manga) {
        document.getElementById('manga-title').textContent = manga.name || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
        document.getElementById('manga-description').textContent = manga.description || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØµÙ';
        document.getElementById('manga-rating').textContent = manga.rating || '0';
        document.getElementById('manga-views').textContent = formatNumber(manga.views || 0);
        
        const cover = document.getElementById('manga-cover');
        if (manga.thumbnail && manga.thumbnail.startsWith('http')) {
            cover.innerHTML = `<img src="${manga.thumbnail}" alt="${manga.name}" 
                                onerror="this.onerror=null; this.style.display='none'; this.parentNode.innerHTML='ğŸ“š';"
                                loading="lazy">`;
        } else {
            cover.innerHTML = 'ğŸ“š';
        }
    }

    // Load chapters - REAL DATA STRUCTURE
    function loadChapters() {
        FirebaseDatabase.getChapters(currentMangaId).then(chapters => {
            if (chapters && chapters.length > 0) {
                allChapters = chapters;
                displayChapters(chapters);
            } else {
                showChaptersEmptyState('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ Ù…ØªØ§Ø­Ø©');
            }
        }).catch(error => {
            console.error('Error loading chapters:', error);
            showChaptersEmptyState('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„: ' + error.message);
        });
    }

    // Display chapters - REAL DATA STRUCTURE
    function displayChapters(chapters) {
        const list = document.getElementById('chapters-list');
        list.innerHTML = '';

        chapters.forEach(chapter => {
            const item = document.createElement('div');
            item.className = 'chapter-item';
            item.innerHTML = `
                <div class="chapter-info">
                    <div class="chapter-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="chapter-details">
                        <div class="chapter-number">${chapter.chapter_name || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}</div>
                        <div class="chapter-date">${formatFirebaseDate(chapter.date_up)}</div>
                    </div>
                </div>
                <button class="chapter-read-btn" onclick="readChapter('${currentMangaId}', '${chapter.id}')">
                    Ø§Ù‚Ø±Ø£ Ø§Ù„Ø¢Ù†
                </button>
            `;
            list.appendChild(item);
        });
    }

    function showChaptersEmptyState(message) {
        const list = document.getElementById('chapters-list');
        list.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ“–</div>
                <p>${message}</p>
            </div>
        `;
    }

    // Sort chapters
    function sortChapters(type) {
        const buttons = document.querySelectorAll('.sort-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        let sorted = [...allChapters];
        if (type === 'latest') {
            sorted.sort((a, b) => new Date(b.date_up || 0) - new Date(a.date_up || 0));
        } else {
            sorted.sort((a, b) => new Date(a.date_up || 0) - new Date(b.date_up || 0));
        }

        displayChapters(sorted);
    }

    // Read chapter
    function readChapter(mangaId, chapterId) {
        window.location.href = `chapter_read.html?mangaId=${mangaId}&chapterId=${chapterId}`;
    }

    // Check if favorite
    function checkIfFavorite() {
        const user = FirebaseAuth.getCurrentUser();
        if (user) {
            FirebaseDatabase.isFavorite(user.uid, currentMangaId).then(isFav => {
                const btn = document.getElementById('favorite-toggle');
                if (isFav) {
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-heart"></i>';
                } else {
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="far fa-heart"></i>';
                }
            });
        }
    }

    // Show error
    function showError(message) {
        const container = document.querySelector('.manga-info-container');
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--accent-secondary);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
                <h2>${message}</h2>
                <button class="btn btn-primary" onclick="navigateTo('index.html')" style="margin-top: 1rem;">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
            </div>
        `;
    }

    // Toggle favorite
    document.addEventListener('DOMContentLoaded', () => {
        const favoriteBtn = document.getElementById('favorite-toggle');
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', () => {
                const user = FirebaseAuth.getCurrentUser();
                if (!user) {
                    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                    navigateTo('auth.html');
                    return;
                }

                FirebaseDatabase.isFavorite(user.uid, currentMangaId).then(isFav => {
                    if (isFav) {
                        FirebaseDatabase.removeFromFavorites(user.uid, currentMangaId).then(() => {
                            favoriteBtn.classList.remove('active');
                            favoriteBtn.innerHTML = '<i class="far fa-heart"></i>';
                            showNotification('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©');
                        });
                    } else {
                        FirebaseDatabase.addToFavorites(user.uid, currentMangaId).then(() => {
                            favoriteBtn.classList.add('active');
                            favoriteBtn.innerHTML = '<i class="fas fa-heart"></i>';
                            showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©');
                        });
                    }
                });
            });
        }

        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle-manga');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                const themeManager = new ThemeManager();
                themeManager.toggleTheme();
            });
        }

        loadMangaDetails();
    });
</script>
</body>
</html>